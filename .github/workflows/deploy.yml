# .github/workflows/deploy.yml

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v3

      # 2. Setup Node.js com cache
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Instalar dependÃªncias do frontend
      - name: ğŸ“¦ Install frontend dependencies
        run: npm ci

      # 4. Build do frontend localmente
      - name: ğŸ—ï¸ Build frontend
        env:
          REACT_APP_AUTH0_DOMAIN: ${{ secrets.REACT_APP_AUTH0_DOMAIN }}
          REACT_APP_AUTH0_CLIENT_ID: ${{ secrets.REACT_APP_AUTH0_CLIENT_ID }}
          REACT_APP_AUTH0_AUDIENCE: ${{ secrets.REACT_APP_AUTH0_AUDIENCE }}
          REACT_APP_API_URL: https://pedidosnicolina.com/api
          REACT_APP_FRONTEND_URL: ${{ secrets.REACT_APP_FRONTEND_URL }}
          CI: false
        run: npm run build

      # 5. Criar arquivo compactado do build
      - name: ğŸ“¦ Create build archive
        run: |
          cd build
          tar -czf ../build.tar.gz .
          cd ..
          ls -lh build.tar.gz
          echo "âœ… Build archive created: $(du -h build.tar.gz | cut -f1)"

      # 6. Enviar build.tar.gz para a VM
      - name: ğŸ“¤ Upload build to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build.tar.gz"
          target: "/home/ubuntu/projects/ordermanager/order-manager/"
          timeout: 10m

      # 7. Deploy e configuraÃ§Ã£o na VM
      - name: ğŸš€ Deploy on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -e
            
            echo "ğŸ“‚ Navegando para o diretÃ³rio do projeto..."
            cd /home/ubuntu/projects/ordermanager/order-manager
            
            echo "ğŸ“¦ Extraindo build do frontend..."
            # Backup do build anterior
            if [ -d "build" ]; then
              echo "ğŸ’¾ Criando backup do build anterior..."
              mv build build.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Criar pasta build e extrair
            mkdir -p build
            tar -xzf build.tar.gz -C build/
            rm build.tar.gz
            echo "âœ… Frontend extraÃ­do com sucesso"
            
            echo "ğŸ”§ Atualizando backend..."
            cd /home/ubuntu/projects/ordermanager/order-manager
            
            # Atualizar cÃ³digo do backend via git
            git pull origin main || echo "âš ï¸ Git pull falhou ou nÃ£o hÃ¡ mudanÃ§as"
            
            echo "ğŸ”§ Configurando ambiente..."
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:/usr/local/bin:$HOME/.nvm/versions/node/v22.20.0/bin:$PATH"
            
            # Instalar dependÃªncias e configurar Prisma
            echo "ğŸ“¦ Instalando dependÃªncias..."
            bun install
            

            # Gerar client e executar migrations do Prisma
            echo "ğŸ”§ Atualizando banco de dados..."
            bunx prisma generate
            bunx prisma migrate deploy

            # Navegar para o diretÃ³rio do backend
            cd src/backend
            
            # Criar/atualizar .env do backend
            echo "ğŸ” Configurando variÃ¡veis de ambiente..."
            cat > .env << 'EOF'
            AUTH0_DOMAIN=${{ secrets.REACT_APP_AUTH0_DOMAIN }}
            AUTH0_AUDIENCE=${{ secrets.REACT_APP_AUTH0_AUDIENCE }}
            DB_HOST=${{ secrets.DATABASE_HOST }}
            DB_USER=${{ secrets.DATABASE_USER }}
            DB_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            DB_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            PORT=4000
            NODE_ENV=production
            DATABASE_URL=mysql://${{ secrets.DATABASE_USER }}:${{ secrets.DATABASE_PASSWORD }}@${{ secrets.DATABASE_HOST }}:3306/${{ secrets.DATABASE_NAME }}
            EOF
            
            echo "ğŸ“¦ Instalando dependÃªncias do backend..."
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:/usr/local/bin:$HOME/.nvm/versions/node/v22.20.0/bin:$PATH"
            bun install
            
            echo "â™»ï¸ Reiniciando serviÃ§os..."
            # Reiniciar backend com PM2
            pm2 restart api-backend || pm2 start "bun run server.ts" --name "api-backend" --interpreter bun
            
            # Aguardar backend iniciar
            sleep 3
            
            # Reiniciar Nginx
            sudo systemctl restart nginx
            
            echo "ğŸ“Š Status dos serviÃ§os:"
            pm2 status
            echo ""
            sudo systemctl status nginx --no-pager -l | head -10
            
            echo "âœ… Deploy concluÃ­do com sucesso!"

      # 8. Verificar saÃºde do site
      - name: ğŸ¥ Health check
        run: |
          echo "â³ Aguardando 15 segundos para o site inicializar..."
          sleep 15
          
          echo "ğŸ” Verificando se o site estÃ¡ respondendo..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://pedidosnicolina.com)
          
          if [ $response -eq 200 ] || [ $response -eq 301 ] || [ $response -eq 302 ]; then
            echo "âœ… Site estÃ¡ no ar! (HTTP $response)"
          else
            echo "âš ï¸ Site retornou HTTP $response"
            echo "Tentando novamente em 10 segundos..."
            sleep 10
            response=$(curl -s -o /dev/null -w "%{http_code}" https://pedidosnicolina.com)
            if [ $response -eq 200 ] || [ $response -eq 301 ] || [ $response -eq 302 ]; then
              echo "âœ… Site estÃ¡ no ar na segunda tentativa! (HTTP $response)"
            else
              echo "âŒ Site nÃ£o estÃ¡ respondendo corretamente"
              exit 1
            fi
          fi

      # 9. Limpar builds antigos na VM (manter Ãºltimos 3)
      - name: ğŸ§¹ Cleanup old builds
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/projects/ordermanager/order-manager
            echo "ğŸ§¹ Limpando builds antigos (mantendo Ãºltimos 3)..."
            ls -t build.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf
            echo "âœ… Limpeza concluÃ­da"

      # 10. NotificaÃ§Ã£o final
      - name: ğŸ‰ Deployment complete
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Frontend: https://pedidosnicolina.com"
          echo "ğŸ”Œ Backend API: https://pedidosnicolina.com/api"
          echo "ğŸ“Š Logs: ssh ubuntu@${{ secrets.REMOTE_HOST }} 'pm2 logs api-backend'"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # 11. NotificaÃ§Ã£o de erro
      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deploy falhou!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Verifique os logs acima"
          echo "ğŸ” Debug: ssh ubuntu@${{ secrets.REMOTE_HOST }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"